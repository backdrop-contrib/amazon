<?php
require_once('includes/AmazonProduct.class.inc');
require_once('includes/AmazonSearchEngine.class.inc');
require_once('includes/Snoopy.class.inc');

function amazon_system($field){
  $system["description"] = t("Make use of the webservices of Amazon.");
  return $system[$field];
}

function amazon_help($type = "administrator") {
  $output = "";
  if ($type == "user") {
    $output .= "<p>". t("Here you can buy stuff at Amazon") ."</p>\n";
  } else {
    $output .= "The Amazon module allows sites to offer a store via the web-services of Amazon.com"; 
  }
  return $output;
}

function amazon_perm() {
  return array("access Amazon", "administer Amazon");
}

function amazon_link($type) {
  if ($type == "page" && user_access("acces Amazon")) {
    $links[] = lm(t("Amazon"), array("mod" => "amazon"), "", array("title" => t("View Amazon")));
  }

  if ($type == "admin" && user_access("administer Amazon")) {
    $links[] = la(t("Amazon"), array("mod" => "amazon"));
  }

  return $links ? $links : array();
}

function amazon_conf_options() {
  $output = form_textfield("Developer key", "amazon_devkey", variable_get("amazon_devkey", ""), 20, 20, "Your Developer key from Amazon.com");
  $output .= form_textfield("Afiliate ID", "amazon_affid", variable_get("amazon_affid", "none"), 20, 40, "Your Amazon affiliate ID");
  $output .= form_select("Number of book shown in block", "amazon_num", variable_get("amazon_num", "1"), array(1 => "1", 2 => "2", 3 => "3")); 
  $output .= form_select("Number of book columns in page", "amazon_columns", variable_get("amazon_columns", "3"),  array(1 => "1", 2 => "2", 3 => "3"));
  return $output;
}

function _amazon_getmodes($all = 0) {
  $output = array();
  if ($all == 0) {
    $qry = "SELECT * FROM amazon_modes WHERE enabled = 1";
  } else {
    $qry = "SELECT * FROM amazon_modes";
  }
  $result = db_query($qry . " ORDER BY long_name");
  while($row = db_fetch_object($result)) {
    $output[$row->short_name] = $row->long_name;
  }
  return $output;
}

function _amazon_searchform($skey = "", $smode="") {
  $frm_output = "<table><tr><td>";
  $frm_output .= form_textfield("", "amazon_search", $skey, 30, 50);
  $frm_output .= "</td><td>";
  $frm_output .= form_select("", "amazon_mode", $smode, _amazon_getmodes());
  $frm_output .= "</td><td>";
  $frm_output .= form_submit(t("Search"));
  $frm_output .= "</td></tr></table>";
  return form($frm_output, "post", drupal_url(array("mod" => "amazon"), "module"));
}

function _amazon_format_item($item) {
  global $theme;
  $output = "<td valign=\"top\">";
  $output .= "<img src=\"".$item->ImageUrlMedium."\" align=\"right\" />";
  $output .= $item->Description . "<br />" . "<b>Released :</b> ".$Item->ReleaseDate . "<br />";
  $output .= "<b>List price :</b> ".$item->ListPrice . "<br />";
  $output .= "<b>Our price :</b> ". $item->OurPrice . "<br />";
  $output .= "<br />";
  $output .= "<a href=\"" . $item->url . "\" target=\"_new\"><b>Buy now !</b></a>"; 
  $output .= "</td>\n";
  return $output;
}

function _amazon_format_row($book_nr, $columns = 3) {
  $output = "";
  if ((($book_nr % $columns) == 1) && ($book_nr > 1)) {
    $output .= "</tr>\n";
  }
  if (($book_nr % $columns) == 1) {
    $output .= "<tr>\n";
  }
  if ($columns == 1) {
    if ($book_nr > 1) {
      $output .= "</tr><tr><td><hr /></td></tr>\n";
    }
    $output .= "<tr>\n";
  }
  return $output;
}

function _amazon_admin_settings() {
  $output = amazon_conf_options();
  $output .= form_submit("Save settings");
  return form($output, "post", "admin.php?mod=amazon");
}

function  _amazon_admin_modes() {
  $output = "<table border=\"2\">\n";
  $output .= "<tr><td><b>Product line</b></td><td><b>Enabled</b></td></tr>\n";
  $result = db_query("SELECT * FROM amazon_modes ORDER BY long_name");
  while($row = db_fetch_object($result)) {
    $output .= "<tr><td>" . $row->long_name . "</td><td>";
    $output .= form_checkbox("", $row->short_name, 1, $row->enabled);
    $output .= "</td></tr>\n";
  }
  $output .= "</table>\n<br />";
  $output .= form_submit("Update modes");
  return form($output, "post", "admin.php?mod=amazon");
}

function _amazon_admin_save($edit = array()) {
  db_query("UPDATE amazon_modes SET enabled = 0");
  foreach ($edit as $name => $value) {
    db_query("UPDATE amazon_modes SET enabled = 1 WHERE short_name = \"$name\"");
  }
  return "The modes have been saved";
}

function amazon_admin() {
  global $op, $edit;
  if (user_access("administer Amazon")) {
    print "<small>" . la(t("settings"), array("mod" => "amazon")) . " | " . la(t("modes"), array("mod" => "amazon", "op" => "modes")) . " | " . la(t("help"), array("mod" => "amazon", "op" => "help")) . "</small>\n";
    print "<br /><br />";
    switch ($op) {
      case "help":
        print amazon_help();
        break;
      case "Save settings":
        print status(system_save($edit));
        print _amazon_admin_settings();
        break;
      case "modes":
        print _amazon_admin_modes();
        break;
      case "Update modes":
        print status(_amazon_admin_save($edit));
        print _amazon_admin_modes();
        break;
      default:
        print _amazon_admin_settings();
    }
  } else {
    print message_access();
  }
}

function amazon_page() {
  global $theme, $edit;

  $theme->header();
  if (user_access("acces Amazon")) {
    print "<center>";
    print _amazon_searchform($edit["amazon_search"]);
    print "</center><br />\n";
    if ($edit["amazon_search"] != "") {
      $am_devkey = variable_get("amazon_devkey", "");
      $am_affid = variable_get("amazon_affid", "none");
      $amazonSE = new AmazonSearchEngine($am_devkey, $am_affid);
      $columns = variable_get("amazon_columns", "3");
      $amazon_mode = $edit["amazon_mode"];
      if ($amazon_mode == "") {
        $row = db_fetch_object(db_query("SELECT * FROM amazon_modes WHERE enabled = 1 LIMIT 1"));
        $amazon_mode = $row->short_name;
      }
      $amazonSE->searchTerm($edit["amazon_search"],$amazon_mode);
      $output = "<center><table border=\"0\" width=\"100%\">\n";
      $book_nr = 1;
      foreach ($amazonSE->results as $result) {
        $output .= _amazon_format_row($book_nr, $columns);
        $output .=_amazon_format_item($result);
        $book_nr++;
      }
      if ($columns > 1) {
        while(($book_nr % $columns) != 1) $book_nr++;
      }
      $output .= "</tr>\n";
      $output .= "</table></center>\n";
      $theme->box(t("Results"), $output);
    }
  } else {
    print message_access();
  }
  $theme->footer();
}

function amazon_block() {
  global $id, $mod;
  $output = "";
  $am_devkey = variable_get("amazon_devkey", "");
  $am_affid = variable_get("amazon_affid", "none");
  $amazonSE = new AmazonSearchEngine($am_devkey, $am_affid);
  if (substr_count(request_uri(), drupal_url())) {
    $modes = _amazon_getmodes();
    $num = variable_get("amazon_num", "1");
    if (module_exist("taxonomy")) {
      $terms = taxonomy_node_get_terms($id);
      $do_title = (count($terms) == 0); 
    } else {
      $do_title = 1;
    }
    if ($do_title) {
      $row = db_fetch_object(db_query("SELECT title FROM node WHERE nid = $id"));
      $terms = explode(" ", $row->title);
    }
    $total_results = 0;
    foreach ($modes as $s_mode => $l_mode) {
      foreach ($terms as $term) {
        if ($total_results < $num) {
          $amazonSE->searchTerm(strtolower(is_object($term) ? $term->name : $term), $s_mode);
          foreach ($amazonSE->results as $item) {
            if (($total_results < $num)) {
              $total_results++;
              $url = $item->url;
              $pic = $item->ImageUrlMedium;
              $prd = $item->ProductName;
              $output .= "<center><a href=\"$url\"><img src=\"$pic\" alt=\"$prd\" border=\"0\" vspace=\"2\" /></a></center><br />\n";
            }
          }
        }
      }
    }
    if (user_access("acces Amazon")) {
      $output .= "<div align=\"right\"><a href=\"module.php?mod=amazon\">more</a></div>";
    }
  }
  $block[0]["subject"] = t("Amazon");
  $block[0]["content"] = $output;
  $block[0]["info"] = t("Amazon");
  return $block;
}
?>
