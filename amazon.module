<?php
require_once("includes/AmazonProduct.class.inc");
require_once("includes/AmazonSearchEngine.class.inc");

if (file_exists("includes/Snoopy.class.inc")) {
  include_once("includes/Snoopy.class.inc");
}

function amazon_system($field){
  $system["description"] = t("Make use of the webservices of Amazon.");
  return $system[$field];
}

function amazon_help($type = "administrator") {
  if ($type == "user") {
    $output = "<p>". t("Here you can buy stuff at our shop") ."</p>";
  } else {
    $output = "The Amazon module allows sites to offer a store via the web-services of Amazon.com";
  }
  return $output;
}

function amazon_perm() {
  return array("access shop", "administer shop", "search shop");
}

function amazon_link($type) {
  $links = array();
  if ($type == "page" && user_access("access shop")) {
    $links[] = l(t("shop"), "amazon");
  }
  else if ($type == "admin") {
    menu("admin/system/modules/amazon/modes", "product lines", "amazon_admin_modes");
  }
  return $links;
}

function amazon_settings() {
  $output = form_textfield("Developer key", "amazon_devkey", variable_get("amazon_devkey", ""), 20, 20, "Your Developer key from Amazon.com");
  $output .= form_textfield("Afiliate ID", "amazon_affid", variable_get("amazon_affid", "none"), 20, 40, "Your Amazon affiliate ID");
  $output .= "<hr /><h3>Amazon block settings</h3>";
  $output .= form_select("Number of book shown in block", "amazon_num", variable_get("amazon_num", "1"), array(1 => "1", 2 => "2", 3 => "3")); 
  $output .= "<hr /><h3>Amazon page settings</h3>";
  $output .= form_select("Number of book columns in page", "amazon_columns", variable_get("amazon_columns", "3"),  array(1 => "1", 2 => "2", 3 => "3"));
  $output .= form_select("Search type", "amazon_searchtype", variable_get("amazon_searchtype", "1"),  array(1 => "Term", 2 => "Browse", 3 => "Listmania", 4=> "Author", 5=> "ASIN", 6 => "UPC", 7 => "ISBN"));
  $output .= form_select("Search mode", "amazon_searchmode", variable_get("amazon_searchmode", ""), _amazon_getmodes(),"mode if applicable");
  $output .= form_textfield("Search term", "amazon_searchterm", variable_get("amazon_searchterm", ""), 20, 50, "Default search term");
  $output .= form_select("Show browse nodes on page", "amazon_shownodes", variable_get("amazon_shownodes", 1), array(0 => "False", 1 => "True"));
  return $output;
}

function _amazon_getmodes($all = 0) {
  $output = array();
  if ($all == 0) {
    $qry = "SELECT * FROM amazon_modes WHERE enabled = 1";
  } else {
    $qry = "SELECT * FROM amazon_modes";
  }
  $result = db_query($qry . " ORDER BY long_name");
  while($row = db_fetch_object($result)) {
    $output[$row->short_name] = $row->long_name;
  }
  return $output;
}

function _amazon_searchform($skey = "", $smode="") {
  if (user_access("search shop")) {
    global $base_url;
    $frm_output = "<div class=\"container-inline\"><div>";
    $frm_output .= form_textfield("", "amazon_search", $skey, 30, 50);
    $frm_output .= "</div><div>";
    $frm_output .= form_select("", "amazon_mode", $smode, _amazon_getmodes());
    $frm_output .= "</div><div>";
    $frm_output .= form_submit(t("Search"));
    $frm_output .= "</div></div>";
    return form($frm_output, "post", url("amazon"));
  } else {
    return "";
  }
}

function _amazon_format_item($item) {

  $output = '<td valign="top">';
  $output .= l('<img src="'.$item->ImageUrlMedium.'" align="right" border = "0"/>', "amazon/asin/$item->Asin");
  $output .= '<b>' . $item->ProductName . '</b><br /><br />';
  if ($item->Manufacturer != '') {
    $output .= '<b>Manufacturer :</b> '. $item->Manufacturer . '<br />';
  }
  if (count($item->Authors) > 0) {
    $output .= '<b>' . format_plural(count($item->Authors), 'Author', 'Authors') . ':</b> ' . implode(',', $item->Authors) . '<br />';
  }
  if (count($item->Artists) > 0) {
    $output .= '<b>' . format_plural(count($item->Artists), 'Artist', 'Artists') . ' :</b> ' . implode(',', $item->Artists) . '<br />';
  }
  if ($item->ReleaseDate != '') {
    $output .= '<b>Released :</b> '. $item->ReleaseDate . '<br />';
  }
  if ($item->getSaving()) {
    $output .= '<b>List price :</b> <s>'.$item->ListPrice . '</s><br />';
    $output .= '<b>Our price :</b> '. $item->OurPrice . '<br />';
    $output .= '<b>You save :</b> $'. $item->getSaving() . '<br />';
  } else {
    $output .= '<b>Price :</b> '. $item->OurPrice . '<br />';
  }
  $output .= '<br />';
  $output .= '<a href="' . $item->url . '" target="_new"><b>Buy now !</b></a>'; 
  $output .= '</td>';
  return $output;
}

function _amazon_format_one_item($item) {
  $output = '<center><table border="0" width="100%">';
  $output .= '<tr>' . _amazon_format_item($item) . '</tr>';
  if ($item->Description != '') {
    $output .= '<tr><td>' . $item->Description . '</td></tr>';
  }
  $output .= '</table></center>';
  return $output;
}

function _amazon_format_row($book_nr, $columns = 3) {
  $output = '';
  if ((($book_nr % $columns) == 1) && ($book_nr > 1)) {
    $output .= '</tr>';
  }
  if (($book_nr % $columns) == 1) {
    $output .= '<tr>';
  }
  if ($columns == 1) {
    if ($book_nr > 1) {
      $output .= '</tr><tr><td><hr /></td></tr>';
    }
    $output .= '<tr>';
  }
  return $output;
}

function  amazon_admin_modes() {
  $op = $_POST["op"];
  $edit = $_POST["edit"];

  if ($op == "Update modes") {
    print status(_amazon_admin_save($edit));
  }
  $output = '<table border="2">';
  $output .= '<tr><td><b>Product line</b></td><td><b>Enabled</b></td></tr>';
  $result = db_query('SELECT * FROM amazon_modes ORDER BY long_name');
  while($row = db_fetch_object($result)) {
    $output .= '<tr><td>' . $row->long_name . '</td><td>';
    $output .= form_checkbox('', $row->short_name, 1, $row->enabled);
    $output .= '</td></tr>';
  }
  $output .= '</table><br />';
  $output .= form_submit('Update modes');
  return form($output, "post", url("admin/system/modules/amazon/modes"));
}

function _amazon_admin_save($edit = array()) {
  db_query('UPDATE amazon_modes SET enabled = 0');
  foreach ($edit as $name => $value) {
    db_query("UPDATE amazon_modes SET enabled = $value WHERE short_name = \"$name\"");
  }
  return 'The modes have been saved';
}

function amazon_admin() {
  $op = $_POST["op"];
  $edit = $_POST["edit"];
  if (empty($op)) {
    $op = arg(1);
  }
  if (user_access('administer shop')) {
    switch ($op) {
      case 'help':
        print amazon_help();
        break;
      case 'Save settings':
        print status(system_save($edit));
        break;
    }
  } else {
    print message_access();
  }
}

function _amazon_browsemenu($mode = '', $browseid = 0) {
  $output = l(t('shop'), "amazon") . '<br />';
  if ($mode == '') {
    $output .= '<br />';
    $modes = _amazon_getmodes();
    foreach($modes as $key => $value) {
      $output .= '<small>';
      $output .= l(t($value), "amazon/$key"); 
      $output .= '</small><br />';
    }
  } else {
    $mode_info = db_fetch_object(db_query("SELECT * FROM amazon_modes WHERE short_name = \"$mode\""));
    $output .= '&nbsp;';
    $output .= l(t($mode_info->long_name), "amazon/$mode") . '<br /><br />';
    $browse_cat = '';
    if ($mode_info->browsenodes != '') {
      $browse_cat = $mode_info->browsenodes;
    } else {
      $browse_cat = $mode_info->long_name;
    }
    $result = db_query('SELECT * FROM amazon_browsenodes WHERE long_name = "' . $browse_cat . '" ORDER BY subcat_name');
    while($browse_node = db_fetch_object($result)) {
      $output .= '<small>';
      if ($browse_node->browse_id != $browseid) {
        $output .= l(t($browse_node->subcat_name), "amazon/$mode/$browse_node->browse_id");
      } else {
        $output .= '<b>' . t($browse_node->subcat_name) . '</b>';
      }
      $output .= '</small><br />';
    }
  }
  return $output;
}

function _amazon_showresults($results) {
  if(count($results) == 0) {
    $output = t('Sorry, nothing was found');
  } else if (count($results) == 1) {
    $output = _amazon_format_one_item($results[0]);
  } else {
    $output = '<center><table border="0" width="100%">';
    $columns = variable_get('amazon_columns', '3');
    $book_nr = 1;
    foreach ($results as $result) {
      $output .= _amazon_format_row($book_nr, $columns);
      $output .= _amazon_format_item($result);
      $book_nr++;
    }
    if ($columns > 1) {
      while(($book_nr % $columns) != 1) $book_nr++;
    }
    $output .= '</tr>';
    $output .= '</table></center>';
  }
  return $output;
}

function amazon_page() {
  global $upc;
  $edit = $_POST["edit"];
  $mode = arg(1);
  $browseid = arg(2);
  $asin = arg(3);

  theme("header");
  if (user_access('access shop')) {
    $am_devkey = variable_get('amazon_devkey', '');
    $am_affid = variable_get('amazon_affid', 'none');
    $show_menu = variable_get('amazon_shownodes', 1);
    $is_search = ($edit['amazon_search'] != '');
    $amazonSE = new AmazonSearchEngine($am_devkey, $am_affid, '2.0');
    if (($is_search)&&($edit['amazon_mode'] != '')) {
      $mode = $edit['amazon_mode'];
      $browseid = 0;
    }
    //print_r($edit);
    $mode = check_query($mode);
    $browseid = check_query($browseid);
    print '<center>';
    print _amazon_searchform($edit['amazon_search'], $mode);
    print '</center><br />';
    print '<table width="100%"><tr>';
    if ($is_search) {
      $amazonSE->searchTerm(check_query($edit['amazon_search']), $mode);
      $box_title = 'Results';
      $box_output = _amazon_showresults($amazonSE->results);
    } else if ($mode != '') {
      $mode_info = db_fetch_object(db_query("SELECT * FROM amazon_modes WHERE short_name = \"$mode\""));
      if ($browseid != 0) {
        $amazonSE->browseNode($browseid, $mode);
        $box_title = 'Browse';
        $box_output = _amazon_showresults($amazonSE->results);
      } else if ($upc != '') {
        $amazonSE->searchUPC(check_query($upc), $mode);
        $box_title = 'Product';
        $box_output = _amazon_showresults($amazonSE->results);
      } else {
        if ($mode_info->browsenodes == '') {
          $mode_longname = $mode_info->long_name;
        } else {
          $mode_longname = $mode_info->browsenodes;
        }
        $qry = 'SELECT * FROM amazon_browsenodes WHERE (long_name = "' . $mode_longname . '") AND (subcat_name = "Top Selling")';
        $browsenode = db_fetch_object(db_query($qry));
        $browseid = $browsenode->browse_id;
        $amazonSE->browseNode($browseid, $mode);
        $box_title = 'Browse';
        $box_output = _amazon_showresults($amazonSE->results);
      }
    } else if ($asin != '') {
      $amazonSE->searchAsin(check_query($asin));
      $box_title = 'Product';
      $box_output = _amazon_showresults($amazonSE->results);
    } else {
      $search_type = check_query(variable_get('amazon_searchtype','1'));
      $search_mode = check_query(variable_get('amazon_searchmode','books'));
      $search_term = check_query(variable_get('amazon_searchterm',''));
      $box_title = 'shop';
      switch($search_type) {
        case 1: //1 => 'Term'
          if (($search_mode != '')&&($search_term != '')) {
            $amazonSE->searchTerm(urlencode($search_term), $search_mode);
            $box_output = _amazon_showresults($amazonSE->results);
          } else {
            $box_output = t('Error');
          }
          break;
        case 2: //2 => 'Browse'
          if (($search_mode != '')&&($search_term != '')) {
            $amazonSE->browseNode(urlencode($search_term), $search_mode);
            $box_output = _amazon_showresults($amazonSE->results);
          } else {
            $box_output = t('Error');
          }
          break;
        case 3: //3 => 'Listmania'
          if ($search_term != '') {
            $amazonSE->listMania($search_term);
            $box_output = _amazon_showresults($amazonSE->results);
          } else {
            $box_output = t('Error');
          }
          break;
        case 4: //4 => 'Author'
          if ($search_term != '') {
            $amazonSE->searchAuthor($search_term);
            $box_output = _amazon_showresults($amazonSE->results);
          } else {
            $box_output = t('Error');
          }
          break;
        case 5: //5 => 'ASIN'
          if ($search_term != '') {
            $amazonSE->searchAsin($search_term);
            $box_output = _amazon_showresults($amazonSE->results);
          } else {
            $box_output = t('Error');
          }
          break;
        case 6: //6 => 'UPC'
          if (($search_mode != '')&&($search_term != '')) {
            $amazonSE->searchUPC(urlencode($search_term), $search_mode);
            $box_output = _amazon_showresults($amazonSE->results);
          } else {
            $box_output = t('Error');
          }
          break;
        case 7://7 => 'ISBN'
          if ($search_term != '') {
            $amazonSE->searchISBN($search_term);
            $box_output = _amazon_showresults($amazonSE->results);
          } else {
            $box_output = t('Error');
          }
          break;
        default:
          $box_output .= '&nbsp;';
          $box_title = 'Error';
      }
    }
    if ($show_menu == '1') {
      print '<td valign="top" style="{width: 155}">';
      theme("box", t('shop'), _amazon_browsemenu($mode, $browseid));
      print '</td>';
    }
    print '<td valign="top">';
    theme("box", t($box_title), $box_output);
    print '</td></tr></table>';
  } else {
    print message_access();
  }
  theme("footer");
}

function amazon_block($op = "list", $delta = 0) {
  if ($op == "list") {
    $blocks[0]['info'] = t('the shop block shows related Amazon.com products when viewing a node.');
    return $blocks;
  }
  else {
    switch($delta) {
      case 0:
        $block = amazon_blockshow();
        break;
    }
    return $block;
  }
}

function amazon_blockshow() {
  global $id, $mod;
  $output = '';
  $am_devkey = variable_get('amazon_devkey', '');
  $am_affid = variable_get('amazon_affid', 'none');
  $amazonSE = new AmazonSearchEngine($am_devkey, $am_affid, '2.0');
  if (substr_count(request_uri(), drupal_url())) {
    $modes = _amazon_getmodes();
    $num = variable_get('amazon_num', '1');
    if (module_exist('taxonomy')) {
      $terms = taxonomy_node_get_terms($id);
      $do_title = (count($terms) == 0); 
    } else {
      $do_title = 1;
    }
    if ($do_title) {
      $row = db_fetch_object(db_query("SELECT title FROM node WHERE nid = $id"));
      $terms = explode(' ', $row->title);
    }
    $total_results = 0;
    foreach ($modes as $s_mode => $l_mode) {
      foreach ($terms as $term) {
        if ($total_results < $num) {
          $amazonSE->searchTerm(strtolower(is_object($term) ? $term->name : $term), $s_mode);
          foreach ($amazonSE->results as $item) {
            if (($total_results < $num)) {
              $total_results++;
              $url = $item->url;
              $pic = $item->ImageUrlMedium;
              $prd = $item->ProductName;
              $output .= "<center><a href=\"$url\"><img src=\"$pic\" alt=\"$prd\" border=\"0\" vspace=\"2\" /></a></center><br />";
            }
          }
        }
      }
    }
    if (user_access('access shop') && ($output != "")) {
      $output .= '<div align="right"><a href="module.php?mod=amazon">more</a></div>';
    }
  }
  $block[0]['subject'] = t('shop');
  $block[0]['content'] = $output;
  return $block;
}
?>
