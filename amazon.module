<?php
// $Id$

/**
 * Amazon Integration
 *
 * Provides a Drupal wrapper and caching mechanism for the Amazon
 * Ecommerce APIs. This module provides no user-visible functionality
 * save configuration and setup.
 */

define('AMAZON_ECS_SCHEMA', '2007-07-16');

/**
 * Implementation of hook_menu. Adds the url path for the Amazon
 * settings page.
 */
function amazon_menu() {
  $items = array();
  $items['admin/settings/amazon'] = array(
    'title' => 'Amazon API',
    'description' => 'Global settings for the Amazon Ecommerce API.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('amazon_settings_form'),
    'file' => 'amazon_admin.inc',
    'access callback' => 'user_access',
    'access arguments' => array('administer amazon'),
    'type' => MENU_NORMAL_ITEM
  );
  $items['admin/settings/amazon/storage'] = array(
    'title' => 'Storage',
    'description' => 'Local data storage settings for Amazon products.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('amazon_storage_settings_form'),
    'file' => 'amazon_admin.inc',
    'access callback' => 'user_access',
    'access arguments' => array('administer amazon'),
    'type' => MENU_LOCAL_TASK
  );
  $items['admin/settings/amazon/test'] = array(
    'title' => 'Test',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('amazon_test_form'),
    'file' => 'amazon_admin.inc',
    'access callback' => 'user_access',
    'access arguments' => array('access devel information'),
    'type' => MENU_LOCAL_TASK
  );
  $items['admin/settings/amazon/upgrade'] = array(
    'page callback' => '_amazon_upgrade',
    'file' => 'amazon_admin.inc',
    'access callback' => 'user_access',
    'access arguments' => array('administer amazon'),
    'type' => MENU_CALLBACK
  );
  $items['admin/settings/amazon/api'] = array(
    'title' => 'Settings',
    'weight' => -10,
    'type' => MENU_DEFAULT_LOCAL_TASK
  );

  return $items;
}

/**
 * Implementation of hook_perm
 */
function amazon_perm() {
  return array('administer amazon');
}


function amazon_http_request($operation, $parameters = array(), $locale = NULL) {
  if (!isset($locale)) {
    $locale = variable_get('amazon_locale', 'US');
  }
  $metadata = amazon_data_cache();
  $locale_data = $metadata['locales'][$locale];

  // Populate the params with default data.
  $parameters += array(
    'Service' => 'AWSECommerceService',
    'Version' => AMAZON_ECS_SCHEMA,
    'AWSAccessKeyId' => variable_get('amazon_aws_access_key', '0CD9RCQYM0TBVH55NB82'),
    'Operation' => $operation,
  );
  if ($associate_id = amazon_get_associate_id()) {
    $parameters += array(
      'AssociateTag' => $associate_id,
    );
  }

  $params = array();
  foreach($parameters as $key => $value) {
    if (is_array($value)) {
      $value = implode(',', $value);
    }
    $params[] = urlencode($key) .'='. urlencode($value);
  }
  module_invoke_all('amazon_request', $parameters);
  $url = $locale_data['url'] .'?'. implode('&', $params);
  // Make the request and return a SimpleXML object.
  $results = drupal_http_request($url, array(), 'GET');
  $xml = new SimpleXMLElement($results->data);
  return $xml;
}

function amazon_item_lookup($item_ids = array(), $force_lookup = TRUE) {
  if (is_string($item_ids)) {
    $item_ids = array($item_ids);
  }
  $items = array();
  if (!$force_lookup) {
    $items = amazon_item_lookup_from_db($item_ids);
  }

  $items_to_fetch = array();
  foreach ($item_ids as $item_id) {
    if (!isset($items[$item_id])) {
      $items_to_fetch[] = $item_id;
    }
  }
  $items_from_web = amazon_item_lookup_from_web($items_to_fetch);

  return array_merge($items, $items_from_web);
}

function amazon_item_lookup_from_web($item_ids = array()) {
  $params = array(
    'ItemId' => implode(',', $item_ids),
    'ResponseGroup' => 'Large',
  );
  $results = amazon_http_request('ItemLookup', $params);
  if (!empty($results->Error)) {
    return FALSE;
  }
  $items = array();
  if (is_array($results->Items->Item)) {
    foreach($results->Items->Item as $xml) {
      $item = amazon_item_clean_xml($xml);
      $items[$item->ASIN] = $item;
    }
  }
  else {
    $item = amazon_item_clean_xml($results->Items->Item);
    $items[$item->ASIN] = $item;
  }
  return $items;
}

function amazon_item_lookup_from_db($item_ids = array()) {
  $sql = "SELECT * FROM {amazon_item} ai WHERE ai.asin IN (''";
  $params = array();
  foreach ($item_ids as $item_id) {
    $query .= ", '%s'";
    $params[] = $item_id;
  }
  $results = db_query($sql, $params);
  $return = array();
  while ($object = db_fetch_object($results)) {
    _amazon_load_child_data($object);
    module_invoke_all('amazon_item_load', $object);
    $return[$object->asin] = $object;
  }
  return $return;
}

function _amazon_load_child_data(&$object) {
  $result = db_query("SELECT feature FROM {amazon_item_feature} WHERE asin = '%s'", $object->ASIN);
  while ($feature = db_fetch_object($result)) {
    $object->Feature[] = $feature->feature;
  }

  $result = db_query("SELECT type, participant FROM {amazon_item_participant} WHERE asin = '%s'", $object->ASIN);
  while ($feature = db_fetch_object($result)) {
    $object->Feature[] = $feature->feature;
  }

  $result = db_query("SELECT feature FROM {amazon_item_image} WHERE asin = '%s'", $object->ASIN);
  while ($feature = db_fetch_object($result)) {
    $object->Feature[] = $feature->feature;
  }
}

function amazon_item_clean_xml($xml) {
  $metadata = amazon_data_cache();
  $item = new stdClass();

  $item->asin = (string)$xml->ASIN;
  $item->salesrank = (string)$xml->SalesRank;
  $item->detailpageurl = (string)$xml->DetailPageURL;

  foreach((array)($xml->ItemAttributes) as $key => $value) {
    $key = strtolower($key);
    $item->$key = $value;
  }

  foreach ($metadata['keys_to_pluralize'] as $type) {
    if (isset($xml->ItemAttributes->$type)) {
      _amazon_clean_single($xml->ItemAttributes, $type);
    }
  }

  foreach (module_implements('_amazon_item_clean_xml') as $module) {
    $function = $module .'_amazon_item_clean_xml';
    $function($item, $xml);
  }
  return $item;
}

function amazon_item_insert($item) {
  $metadata = amazon_data_cache();
  drupal_write_record('amazon_item', $item->ItemAttributes);

  // Handle the various credits for a product, including Artist, Author,
  // Actor, etc. We map these to a separate table.
  foreach ($metadata['participant_types'] as $type) {
    if (isset($item->ItemAttributes->$type) && in_array($type, amazon_get_cacheable_chunk_list())){
      foreach($item->ItemAttributes->$type as $participant) {
        $item_participant = array('asin' => $item->ASIN, 'type' => $type, 'particpant' => $participant);
        drupal_write_record('amazon_item_participant', $item_participant);
      }
    }
  }

  // Clean up the 'Features' data and see if the element exists.
  if (isset($item->Feature) && in_array('Feature', amazon_get_cacheable_chunk_list())) {
    foreach($item->Feature as $feature) {
      $item_feature = array('asin' => $item->ASIN, 'feature' => $feature);
      drupal_write_record('amazon_item_feature', $item_feature);
    }
  }

  // Save the product images if they exist.
  if (isset($item->ImageSets)) {
    foreach($item->ImageSets->ImageSet as $size => $data) {
      if ($size != '@attributes') {
        $image = (object)array('asin' => $item->ASIN, 'size' => $size, 'height' => $data->Height, 'width' => $data->Width, 'url' => $data->URL);
        drupal_write_record('amazon_item_image', $image);
      }
    }
  }

  module_invoke_all('amazon_item_insert', $item);
}

function amazon_item_save($item) {
  // We have boatloads of data to insert in here, so we're going to
  // cheat and blow away the old entries and re-insert them in 'silent'
  // mode.
  amazon_item_delete($item->ASIN);
  amazon_item_insert($item, TRUE);
}

function amazon_item_delete($asin, $silent = FALSE) {
  module_invoke_all('amazon_item_delete', $asin);
  db_query("DELETE FROM {amazon_item} WHERE asin = '%s'", $asin);
  db_query("DELETE FROM {amazon_item_participant} WHERE asin = '%s'", $asin);
  db_query("DELETE FROM {amazon_item_feature} WHERE asin = '%s'", $asin);
  db_query("DELETE FROM {amazon_item_image} WHERE asin = '%s'", $asin);
}


/**
 * Utility functions for managing AmazonItem/Node relationships
 */

function amazon_item_node_save($asin, $nid, $module = 'amazon', $weight = 0) {
  amazon_item_node_delete($asin, $nid, $module);
  db_query("INSERT INTO {amazon_item_node} (asin, nid, module, weight) VALUES ('%s', %d, '%s', %d)", $asin, $nid, $module, $weight);
}

function amazon_item_node_delete($asin = NULL, $nid = NULL, $module = NULL) {
  $sql = "DELETE FROM {amazon_item_node} WHERE 1 = 1";
  $params = array();
  if (isset($asin)) {
    $sql = " AND asin = '%s'";
    $params[] = $asin;
  }

  if (isset($nid)) {
    $sql = " AND nid = %d";
    $params[] = $nid;
  }

  if (isset($module)) {
    $sql = " AND module = '%s'";
    $params[] = $module;
  }

  if (count($params)) {
    db_query($sql, $params);
  }
}

/**
 * Misc. helper functions for managing the wide array of Amazon
 * data bitsies.
 */

function _amazon_clean_single(&$item, $type) {
  if (isset($item->{$type}) && is_string($item->{$type})) {
    $item->{$type} = array($item->{$type});
  }
}

function amazon_data_cache($reset = FALSE) {
  static $data;
  if (!isset($data) || $reset) {
    if (!$reset && ($cache = cache_get('amazon:metadata')) && !empty($cache->data)) {
      $data = $cache->data;
    }
    else {
      $data = array();
      $data['participant_types'] = array('Actor', 'Artist', 'Author', 'Director');
      $data['keys_to_pluralize'] = array('Actor', 'Artist', 'Author', 'Director', 'Feature');
      $data['locales'] = _amazon_default_locales();

      drupal_alter('amazon_metadata', $data);
      cache_set('amazon:metadata', $data);
    }
  }
  return $data;
}

function _amazon_default_locales() {
  $locales = array();
  $locales['US'] = array(
    'url'     => 'http://ecs.amazonaws.com/onca/xml',
    'name'    => t('United States'),
  );
  $locales['UK'] = array(
    'url'     => 'http://ecs.amazonaws.uk/onca/xml',
    'name'    => t('United Kingdom'),
  );
  $locales['JP'] = array(
    'url'     => 'http://ecs.amazonaws.jp/onca/xml',
    'name'    => t('Japan'),
  );
  $locales['FR'] = array(
    'url'     => 'http://ecs.amazonaws.fr/onca/xml',
    'name'    => t('France'),
  );
  $locales['DE'] = array(
    'url'     => 'http://ecs.amazonaws.de/onca/xml',
    'name'    => t('Germany'),
  );
  $locales['CA'] = array(
    'url'     => 'http://ecs.amazonaws.ca/onca/xml',
    'name'    => t('Canada'),
  );

  return $locales;
}

function amazon_get_associate_id() {
  switch (variable_get('amazon_associate_setting', 'author')) {
    case 'association':
      return 'drupal0a-20';
      break;
    case 'author':
      return 'viaposit-20';
      break;
    case 'custom':
      return variable_get('amazon_custom_associate_id', '');
      break;
    default:
      return FALSE;
  }
}

function amazon_get_cacheable_chunk_list() {
  $defaults = array(
    'Author', 'ImageSets', 'Artist'
  );
  return variable_get('amazon_extra_data', $defaults);
}

function amazon_cron() {
  // Here, we're going to chug through all the existing ASINs and update them.
  // We'll grab 20 at a time to avoid thrashing things.
  $sql = "SELECT asin FROM {amazon_item} WHERE timestamp < %d";
  $result = db_query_range($sql, time() - variable_get('amazon_refresh_schedule', 86400), 1, 20);
  $asins = array();

  while($item = db_fetch_object($result)) {
    $asins[] = $item->asin;
  }

  if ($items = amazon_item_lookup_from_web($asins)) {
    foreach ($items as $item) {
      amazon_item_save($item);
    }
  }
  else {
    watchdog('Amazon', t('Amazon items could not be updated.'));
  }
}
